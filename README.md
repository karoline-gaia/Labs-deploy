# Weather Service - Sistema de Consulta de Clima por CEP

Sistema em Go que recebe um CEP brasileiro, identifica a cidade e retorna o clima atual em Celsius, Fahrenheit e Kelvin.

## üåê Servi√ßo em Produ√ß√£o

**URL do servi√ßo deployado no Google Cloud Run:**
```
https://weather-service-175512104676.us-central1.run.app
```

### üß™ Testes R√°pidos

```bash
# Health Check
curl https://weather-service-175512104676.us-central1.run.app/

# CEP v√°lido (S√£o Paulo - Av. Paulista)
curl https://weather-service-175512104676.us-central1.run.app/weather/01310100

# CEP inv√°lido (retorna 422)
curl https://weather-service-175512104676.us-central1.run.app/weather/123

# CEP n√£o encontrado (retorna 404)
curl https://weather-service-175512104676.us-central1.run.app/weather/99999999
```

### üåç Testar no Navegador

- **S√£o Paulo:** https://weather-service-175512104676.us-central1.run.app/weather/01310100
- **Rio de Janeiro:** https://weather-service-175512104676.us-central1.run.app/weather/20040020
- **Belo Horizonte:** https://weather-service-175512104676.us-central1.run.app/weather/30130100

## üìã Requisitos

- Go 1.21 ou superior (para desenvolvimento local)
- Docker e Docker Compose (para testes locais)
- Chave de API do WeatherAPI (gratuita em https://www.weatherapi.com/)
- Conta Google Cloud Platform (para deploy)

## üöÄ Como Executar Localmente

### 1. Configurar a API Key

Crie um arquivo `.env` na raiz do projeto:

```bash
cp .env.example .env
```

Edite o arquivo `.env` e adicione sua chave de API do WeatherAPI:

```
WEATHER_API_KEY=sua_chave_api_aqui
```

### 2. Executar com Docker Compose

```bash
docker-compose up --build
```

O servi√ßo estar√° dispon√≠vel em `http://localhost:8080`

### 3. Executar sem Docker

```bash
# Instalar depend√™ncias
go mod download

# Configurar a vari√°vel de ambiente
export WEATHER_API_KEY=sua_chave_api_aqui

# Executar
go run main.go
```

## üß™ Executar Testes

```bash
# Executar todos os testes
go test -v

# Executar testes com cobertura
go test -v -cover

# Gerar relat√≥rio de cobertura
go test -coverprofile=coverage.out
go tool cover -html=coverage.out
```

## üì° Endpoints da API

### GET /weather/{cep}

Retorna a temperatura atual para o CEP informado.

**Formato do CEP:** 8 d√≠gitos (com ou sem h√≠fen)

**Exemplo de requisi√ß√£o:**

```bash
# Produ√ß√£o
curl https://weather-service-175512104676.us-central1.run.app/weather/01310100

# Local
curl http://localhost:8080/weather/01310100
```

**Respostas:**

#### ‚úÖ Sucesso (200 OK)
```json
{
  "temp_C": 28.5,
  "temp_F": 83.3,
  "temp_K": 301.5
}
```

#### ‚ùå CEP Inv√°lido (422 Unprocessable Entity)
Quando o CEP n√£o possui 8 d√≠gitos ou cont√©m caracteres inv√°lidos.

```json
{
  "message": "invalid zipcode"
}
```

#### ‚ùå CEP N√£o Encontrado (404 Not Found)
Quando o CEP √© v√°lido mas n√£o existe na base do ViaCEP.

```json
{
  "message": "can not find zipcode"
}
```

### GET /

Health check do servi√ßo.

```bash
# Produ√ß√£o
curl https://weather-service-175512104676.us-central1.run.app/

# Local
curl http://localhost:8080/
```

**Resposta:**
```json
{
  "status": "ok"
}
```

## üß™ Exemplos de Teste Completos

### Testando o Servi√ßo em Produ√ß√£o

```bash
# 1. Health Check
curl https://weather-service-175512104676.us-central1.run.app/
# Resposta esperada: {"status":"ok"}

# 2. CEP v√°lido (Av. Paulista, S√£o Paulo)
curl https://weather-service-175512104676.us-central1.run.app/weather/01310100
# Resposta esperada: {"temp_C":XX.X,"temp_F":XX.X,"temp_K":XXX.X}

# 3. CEP v√°lido com h√≠fen
curl https://weather-service-175512104676.us-central1.run.app/weather/01310-100
# Resposta esperada: {"temp_C":XX.X,"temp_F":XX.X,"temp_K":XXX.X}

# 4. CEP inv√°lido (formato incorreto) - Retorna 422
curl https://weather-service-175512104676.us-central1.run.app/weather/123
# Resposta esperada: {"message":"invalid zipcode"}

# 5. CEP n√£o encontrado - Retorna 404
curl https://weather-service-175512104676.us-central1.run.app/weather/99999999
# Resposta esperada: {"message":"can not find zipcode"}
```

### Outros CEPs para Teste

```bash
# Rio de Janeiro - Centro
curl https://weather-service-175512104676.us-central1.run.app/weather/20040020

# Belo Horizonte - Centro
curl https://weather-service-175512104676.us-central1.run.app/weather/30130100

# Curitiba - Centro
curl https://weather-service-175512104676.us-central1.run.app/weather/80010000

# Porto Alegre - Centro
curl https://weather-service-175512104676.us-central1.run.app/weather/90010000
```

## üèóÔ∏è Estrutura do Projeto

```
weather-service/
‚îú‚îÄ‚îÄ main.go              # C√≥digo principal da aplica√ß√£o
‚îú‚îÄ‚îÄ main_test.go         # Testes automatizados em Go
‚îú‚îÄ‚îÄ go.mod               # Depend√™ncias do Go
‚îú‚îÄ‚îÄ go.sum               # Checksums das depend√™ncias
‚îú‚îÄ‚îÄ Dockerfile           # Container Docker (multi-stage build)
‚îú‚îÄ‚îÄ docker-compose.yml   # Orquestra√ß√£o Docker
‚îú‚îÄ‚îÄ .env.example         # Exemplo de vari√°veis de ambiente
‚îú‚îÄ‚îÄ .dockerignore        # Arquivos ignorados no build Docker
‚îú‚îÄ‚îÄ .gcloudignore        # Arquivos ignorados no deploy GCP
‚îú‚îÄ‚îÄ .gitignore           # Arquivos ignorados pelo Git
‚îî‚îÄ‚îÄ README.md            # Documenta√ß√£o
```

## üåê Deploy no Google Cloud Run

### M√©todo Recomendado: Google Cloud Shell

O m√©todo mais f√°cil √© usar o **Google Cloud Shell** (terminal integrado no navegador):

#### 1. Acessar o Console
- Acesse: https://console.cloud.google.com/
- Fa√ßa login e crie/selecione um projeto
- Habilite o billing (necess√°rio mesmo para free tier)

#### 2. Abrir Cloud Shell
- Clique no √≠cone **`>_`** no canto superior direito
- Aguarde o terminal abrir

#### 3. Clonar o Reposit√≥rio

```bash
# Clonar o projeto
git clone https://github.com/karoline-gaia/Labs-deploy.git
cd Labs-deploy
```

#### 4. Executar o Deploy

```bash
# Configurar projeto
gcloud config set project fullcycle01

# Definir API Key do WeatherAPI
export WEATHER_API_KEY="e3a7bd5d41e0453391a220046252810"

# Deploy (aguarde 3-5 minutos)
gcloud run deploy weather-service \
  --source . \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars WEATHER_API_KEY=$WEATHER_API_KEY \
  --memory 256Mi \
  --cpu 1 \
  --max-instances 10
```

#### 5. Redeploy (Atualizar o Servi√ßo)

Para atualizar o servi√ßo ap√≥s mudan√ßas no c√≥digo:

```bash
cd ~/Labs-deploy
git pull origin main
./redeploy.sh
```

Ou manualmente:

```bash
cd ~/Labs-deploy
git pull origin main

export WEATHER_API_KEY="e3a7bd5d41e0453391a220046252810"

gcloud run deploy weather-service \
  --source . \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars WEATHER_API_KEY=$WEATHER_API_KEY
```

### Comandos √öteis

```bash
# Ver logs em tempo real (√∫til para debug)
gcloud run services logs tail weather-service --region us-central1

# Ver logs das √∫ltimas 50 linhas
gcloud run services logs read weather-service --region us-central1 --limit 50

# Obter URL do servi√ßo
gcloud run services describe weather-service \
  --region us-central1 \
  --format 'value(status.url)'

# Atualizar vari√°vel de ambiente
gcloud run services update weather-service \
  --region us-central1 \
  --set-env-vars WEATHER_API_KEY=nova_chave

# Deletar o servi√ßo
gcloud run services delete weather-service --region us-central1
```

### Custos

- **GRATUITO** no free tier do Google Cloud Run
- 2 milh√µes de requisi√ß√µes/m√™s gr√°tis
- 360.000 GB-segundos de mem√≥ria/m√™s gr√°tis
- 180.000 vCPU-segundos/m√™s gr√°tis

## üîß Tecnologias Utilizadas

- **Go 1.21**: Linguagem de programa√ß√£o
- **ViaCEP API**: Consulta de CEPs brasileiros (https://viacep.com.br/)
- **WeatherAPI**: Consulta de dados meteorol√≥gicos (https://www.weatherapi.com/)
- **Docker**: Containeriza√ß√£o com multi-stage build
- **Google Cloud Run**: Hospedagem serverless
- **testify**: Framework de testes para Go

## üìù Convers√µes de Temperatura

As convers√µes s√£o realizadas conforme especificado:

- **Celsius para Fahrenheit**: `F = C √ó 1.8 + 32`
- **Celsius para Kelvin**: `K = C + 273`

## üß™ Cobertura de Testes

Os testes automatizados (`main_test.go`) cobrem:

- ‚úÖ **Valida√ß√£o de formato de CEP**: 8 d√≠gitos, com/sem h√≠fen, caracteres inv√°lidos
- ‚úÖ **Convers√µes de temperatura**: Precis√£o das f√≥rmulas C‚ÜíF e C‚ÜíK
- ‚úÖ **Respostas HTTP corretas**: Status codes 200, 404, 422
- ‚úÖ **Tratamento de erros**: CEP inv√°lido, CEP n√£o encontrado
- ‚úÖ **Health check endpoint**: Verifica√ß√£o de disponibilidade

**Executar testes localmente:**
```bash
go test -v -cover
```

## üîç Troubleshooting

### Erro: "error fetching weather data"

Se voc√™ receber este erro, verifique:

1. **API Key configurada corretamente:**
```bash
# No Cloud Shell, verificar se a vari√°vel est√° definida
gcloud run services describe weather-service --region us-central1 --format 'value(spec.template.spec.containers[0].env[0].value)'
```

2. **Ver logs detalhados:**
```bash
# Logs em tempo real
gcloud run services logs tail weather-service --region us-central1

# √öltimas 100 linhas
gcloud run services logs read weather-service --region us-central1 --limit 100
```

3. **Testar localmente:**
```bash
export WEATHER_API_KEY="e3a7bd5d41e0453391a220046252810"
docker-compose up
curl http://localhost:8080/weather/01310100
```

### Melhorias Implementadas

**v1.1 - Logs e Tratamento de Erros Aprimorados:**
- ‚úÖ Logs detalhados em cada etapa do processamento
- ‚úÖ Mensagens de erro mais espec√≠ficas
- ‚úÖ Valida√ß√£o da API Key no in√≠cio
- ‚úÖ Rastreamento completo de requisi√ß√µes
- ‚úÖ Detalhes de erros da Weather API nos logs

Para ver os logs ap√≥s fazer uma requisi√ß√£o:
```bash
gcloud run services logs read weather-service --region us-central1 --limit 20
```

## üìä Requisitos Atendidos

- ‚úÖ Sistema recebe CEP v√°lido de 8 d√≠gitos
- ‚úÖ Realiza pesquisa do CEP via ViaCEP
- ‚úÖ Consulta temperatura via WeatherAPI
- ‚úÖ Retorna temperaturas em Celsius, Fahrenheit e Kelvin
- ‚úÖ Responde com c√≥digo 200 em caso de sucesso
- ‚úÖ Responde com c√≥digo 422 para CEP inv√°lido
- ‚úÖ Responde com c√≥digo 404 para CEP n√£o encontrado
- ‚úÖ Testes automatizados implementados
- ‚úÖ Docker e docker-compose configurados
- ‚úÖ Deploy realizado no Google Cloud Run
- ‚úÖ Endere√ßo ativo e acess√≠vel
- ‚úÖ Logs detalhados para debugging
- ‚úÖ Tratamento robusto de erros

## üìÑ Licen√ßa

Este projeto foi desenvolvido para fins educacionais como parte de um desafio t√©cnico.

## üë§ Autor

Desenvolvido em Go com foco em boas pr√°ticas, clean code, testes automatizados e deploy em cloud.
